services:
  # The Web Server (Handles incoming traffic)
  web:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    container_name: web_server_lytestorage
    ports:
      - "${PORT:-8080}:${PORT:-8080}"
    environment:
      - PORT=${PORT:-8080}
    depends_on:
      - php
    restart: unless-stopped

  # The PHP Processor (Uses your custom Dockerfile)
  php:
    build: .
    container_name: php_processor
    volumes:
      - ./PHP:/var/www/html
    entrypoint: >
      sh -c "mkdir -p /var/www/html/server/images && 
             chown -R www-data:www-data /var/www/html/server/images && 
             chmod -R 777 /var/www/html/server/images && 
             php-fpm"
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      PMA_HOST: ${PMA_HOST}
    restart: always

  # The Database
  db:
    image: mariadb:lts 
    container_name: database
    volumes:
      - ./MariaDB:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Database Management Tool
  phpmyadmin:
    image: phpmyadmin:latest
    ports:
      - "8081:80"
    environment:
      PMA_HOST: ${PMA_HOST}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
